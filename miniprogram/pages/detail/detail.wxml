<view class="page-container" wx:if="{{!isFinished}}" bindtouchstart="onTouchStart" bindtouchend="onTouchEnd">
  <view class="header">
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progress + '%'}}"></view>
      </view>
      <view class="stats">{{currentWordIndex + 1}} / {{totalWords}}</view>
    </view>
  </view>

  <view class="question-zone mc-style">
    <block wx:if="{{currentQuestion.type === 'mc'}}">
      <view class="mc-question-word">{{currentQuestion.word}}</view>
      <view class="phonetics-area" bindtap="playWordAudio" data-word="{{currentQuestion.word}}">
        <text class="phonetics">{{currentQuestion.phonetics}}</text>
        <image class="pronounce-icon" src="/images/pronounce.png"></image>
      </view>
    </block>

    <block wx:if="{{currentQuestion.type === 'sp'}}">
      <view class="mc-question-word">{{currentQuestion.question}}</view>
      <!-- 发音重播按钮（拼写题） -->
      <view class="phonetics-area replay" bindtap="playWordAudio" data-word="{{currentQuestion.word}}">
        <image class="pronounce-icon" src="/images/pronounce.png"></image>
      </view>

      <!-- 取消顶部舞台展示，改为贴近手指区展示（见下方 interaction-zone 内） -->
    </block>
    <!-- 回看导航：题目卡片两侧，几乎透明 -->
    <view class="review-nav left {{currentWordIndex>0 ? '' : 'disabled'}}" bindtap="onPrevTap">‹</view>
    <view class="review-nav right {{canNextArrow ? '' : 'disabled'}}" bindtap="onNextTap">›</view>
  </view>



  <view class="interaction-zone">
    <block wx:if="{{currentQuestion.type === 'mc'}}">
      <!-- 固定高度的选项容器，防止位置位移；所有覆盖层放在该容器内部，绝对定位覆盖，不参与文档流 -->
      <view class="mc-options-container">
        <view class="mc-options-grid">
          <view wx:for="{{currentQuestion.options}}" wx:key="index"
                class="mc-option-card {{item.status}}"
                bindtap="onMcOptionTap"
                data-option-def="{{item.def}}"
                hover-class="{{isAnswered ? '' : 'card-hover'}}"
                hover-stay-time="50">
            <text class="option-def">{{item.def}}</text>
            <view class="feedback-icon {{item.status}}">
              <text wx:if="{{item.status === 'correct'}}">✔</text>
              <text wx:if="{{item.status === 'incorrect'}}">✕</text>
            </view>
          </view>
        </view>
        
        <!-- 错误反馈层（覆盖，不改变布局） -->
        <view class="error-feedback-layer" wx:if="{{showErrorFeedback}}">
          <view class="error-feedback-content">
            <view class="error-feedback-header">
              <view class="error-icon">✕</view>
              <view class="error-title">答错了，再想想？</view>
            </view>
            <view class="error-feedback-text">正确答案是：{{correctAnswerText}}</view>
            <view class="error-feedback-actions">
              <button class="retry-btn" bindtap="retryQuestion" disabled="{{retryButtonDisabled}}">再试一次</button>
              <button class="continue-btn-error" bindtap="goToNextQuestion" disabled="{{continueButtonDisabled}}">继续</button>
            </view>
          </view>
        </view>

      </view>
    </block>

    <!-- 拼写题：字母卡片模式（选中字母+操作区紧贴手指） -->
    <block wx:if="{{currentQuestion.type === 'sp'}}">
      <view class="sp-chosen {{chosenShake ? 'shake' : ''}}">
        <!-- 错误提示卡片：放在删除/清空上方，且不遮挡按钮 -->
        <view class="sp-error-card" wx:if="{{isAnswered && spellingDiff}}">
          <view class="error-header">
            <view class="error-icon">✕</view>
            <view class="error-title">拼写错误</view>
          </view>
          <view class="spelling-comparison">
            <view class="comparison-row">
              <view class="comparison-label">你的答案：</view>
              <view class="comparison-word">
                <text wx:for="{{spellingDiff.userInput}}" wx:key="index" class="spelling-char {{item.status}}">{{item.char}}</text>
              </view>
            </view>
            <view class="comparison-row">
              <view class="comparison-label">正确答案：</view>
              <view class="comparison-word correct-answer">
                <text wx:for="{{spellingDiff.correctAnswer}}" wx:key="index" class="spelling-char correct">{{item.char}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 选中字母：紧贴手指区域（仅在未判分或判对时显示） -->
        <view class="sp-chosen-letters {{spStageClass}}" wx:if="{{!isAnswered || (isAnswered && !spellingDiff)}}">
          <text wx:for="{{chosenLetters}}" wx:key="index" class="sp-chosen-letter">{{item.char}}</text>
        </view>

        <view class="sp-chosen-actions" wx:if="{{!isAnswered}}">
          <button class="sp-action-btn" bindtap="onDeleteLast" disabled="{{isAnswered || chosenLetters.length===0}}">删除</button>
          <button class="sp-action-btn" bindtap="onClearLetters" disabled="{{isAnswered || chosenLetters.length===0}}">清空</button>
        </view>
      </view>

      <view class="sp-tiles-grid">
        <view wx:for="{{letterBank}}" wx:key="index"
              class="sp-tile {{item.used ? 'used' : ''}} {{item.picked ? 'picked' : ''}}"
              bindtap="onLetterTap"
              data-index="{{index}}">
          {{item.char}}
        </view>
      </view>

      <!-- 主要按钮与字母区共位：未提交显示“确认”，提交后替换为“继续” -->
      <button wx:if="{{!isAnswered}}"
              class="sp-submit-btn {{chosenLetters.length>0 ? 'active' : ''}}"
              bindtap="onTileSpellingSubmit"
              disabled="{{chosenLetters.length===0}}">确认</button>
      <button wx:elif="{{isAnswered}}"
              class="sp-submit-btn continue"
              bindtap="nextWord">继续</button>
    </block>

    <!-- 移除交互区内的回看箭头（仅保留题目区两侧的箭头） -->
  </view>

  <!-- 移除底部反馈提示，避免遮挡选项 -->

  <!-- 移除固定底部继续按钮（已与确认共位） -->

  <!-- 简化的成功提示 -->
  <view class="success-toast" wx:if="{{showCelebration}}">
    <view class="success-icon">✓</view>
    <view class="success-text">答对了</view>
  </view>

</view>

<!-- 完成结果页 -->
<view class="finish-container" wx:if="{{isFinished}}">
  <view class="finish-header">
    <view class="finish-title">{{reviewMode ? '本轮错题复习完成' : '本次练习完成'}}</view>
    <view class="finish-subtitle">共 {{totalWords}} 题，正确 {{correctCount}} 题</view>
    <view class="finish-subtitle" wx:if="{{percentileMeta}}">超过了 {{percentileMeta.percentile}}% 的同学（参与人数 {{percentileMeta.total}}）</view>
  </view>

  <view class="finish-score-card">
    <view class="score-value">{{score}}</view>
    <view class="score-label">正确率</view>
  </view>

  <view class="summary-scroll-area">
    <view class="summary-list-title">本次答题概览</view>
    <scroll-view scroll-y class="summary-list" style="max-height: 600rpx;">
      <view wx:for="{{summaryList}}" wx:key="index" class="summary-item">
        <view class="summary-word-info">
          <view class="summary-word">{{item.word}}</view>
          <view class="summary-def">{{item.def}}</view>
        </view>
        <view class="summary-status {{item.isCorrect ? 'correct' : 'incorrect'}}">{{item.isCorrect ? '✔' : '✕'}}</view>
      </view>
    </scroll-view>
  </view>

  <view class="floating-actions">
    <button class="action-btn retry" bindtap="retryPractice">再练一次</button>
    <button class="action-btn mistakes" bindtap="viewMistakes" disabled="{{mistakes.length===0}}">错题复习</button>
    <button class="action-btn back" bindtap="goBack">回到主页</button>
  </view>
</view>